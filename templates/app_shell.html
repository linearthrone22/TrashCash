<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Go Can Hackathon</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        /* Embedded CSS from base.html and style.css */
        body { 
            font-family: 'Inter', sans-serif; 
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }
        main {
            flex-grow: 1;
        }
        .map-container { height: 300px; width: 100%; border-radius: 0.5rem; margin-bottom: 1rem; background-color: #e5e7eb; }
        .buyer-map-container { height: 400px; } /* Specific height for buyer map */
        .modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0,0,0,0.5); display: none; /* Initially hidden */
            justify-content: center; align-items: center; z-index: 1000;
        }
        .modal-content { background-color: white; padding: 20px; border-radius: 8px; width: 90%; max-width: 500px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .auth-container { max-width: 400px; margin: 2rem auto; padding: 2rem; background-color: #f9fafb; border-radius: 0.5rem; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -1px rgba(0,0,0,0.06); }
        .btn { padding: 0.75rem 1.5rem; border-radius: 0.375rem; font-weight: 600; transition: background-color 0.2s; cursor: pointer; }
        .btn-primary { background-color: #2563eb; color: white; }
        .btn-primary:hover { background-color: #1d4ed8; }
        .btn-secondary { background-color: #6b7280; color: white; }
        .btn-secondary:hover { background-color: #4b5563; }
        .btn-sm { padding: 0.5rem 1rem; font-size: 0.875rem; }
        .input-field { width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 0.375rem; margin-bottom: 1rem; }
        .nav-link { padding: 0.5rem 1rem; border-radius: 0.375rem; cursor: pointer; }
        .nav-link:hover { background-color: #e5e7eb; }
        .nav-link.active { color: #2563eb; font-weight: 600; }
        #user-info { font-weight: bold; }
        .listing-card { border: 1px solid #e5e7eb; border-radius: 0.5rem; padding: 1rem; margin-bottom: 1rem; background-color: white; }
        .page-section { display: none; /* All sections hidden by default */ }
        .page-section.active { display: block; /* Active section is shown */ }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">
    <nav class="bg-white shadow-md p-4">
        <div class="container mx-auto flex justify-between items-center">
            <a href="javascript:void(0);" onclick="navigateTo('home')" class="text-2xl font-bold text-green-600">♻️ Go Can</a>
            <div>
                <span id="user-info" class="mr-4"></span>
                <a href="javascript:void(0);" onclick="navigateTo('home')" id="nav-home" class="nav-link">Home</a>
                <a href="javascript:void(0);" onclick="navigateTo('login')" id="nav-login" class="nav-link">Login</a>
                <a href="javascript:void(0);" onclick="navigateTo('signup')" id="nav-signup" class="nav-link">Sign Up</a>
                <a href="javascript:void(0);" onclick="navigateTo('seller_dashboard')" id="nav-seller-dashboard" class="nav-link hidden">Seller Dashboard</a>
                <a href="javascript:void(0);" onclick="navigateTo('buyer_dashboard')" id="nav-buyer-dashboard" class="nav-link hidden">Buyer Dashboard</a>
                <button id="logout-button" class="btn btn-secondary hidden ml-2">Logout</button>
            </div>
        </div>
    </nav>

    <main class="container mx-auto p-4 mt-4">
        <section id="page-home" class="page-section">
            <div class="text-center p-10 bg-white rounded-lg shadow-xl">
                <h1 class="text-4xl font-bold mb-6 text-green-700">Welcome to Go Can!</h1>
                <p class="text-xl mb-8 text-gray-700">Connecting waste sellers with buyers, efficiently and transparently.</p>
                <p class="mb-4">Turn your recyclables into resources. Help the environment and earn money.</p>
                <div class="space-x-4">
                    <button onclick="navigateTo('signup')" class="btn btn-primary text-lg">Get Started - Sign Up</button>
                    <button onclick="navigateTo('login')" class="btn btn-secondary text-lg">Already a User? Login</button>
                </div>
                <div class="mt-12 grid md:grid-cols-2 gap-8 text-left">
                    <div class="p-6 bg-green-50 rounded-lg border border-green-200">
                        <h2 class="text-2xl font-semibold mb-3 text-green-800"><i class="fas fa-recycle mr-2"></i>For Sellers</h2>
                        <p class="text-gray-600">Easily list your recyclable materials (plastic, paper, metal, etc.). Find local collectors and get fair prices. Set your location and let buyers find you!</p>
                    </div>
                    <div class="p-6 bg-blue-50 rounded-lg border border-blue-200">
                        <h2 class="text-2xl font-semibold mb-3 text-blue-800"><i class="fas fa-truck-loading mr-2"></i>For Buyers (Collectors/Factories)</h2>
                        <p class="text-gray-600">Discover available recyclable materials in your area. Connect with sellers directly. Expand your collection network and contribute to a circular economy.</p>
                    </div>
                </div>
            </div>
        </section>

        <section id="page-signup" class="page-section">
            <div class="auth-container">
                <h2 class="text-2xl font-bold mb-6 text-center">Create Your Go Can Account</h2>
                <form id="signup-form">
                    <input type="email" id="signup-email" placeholder="Email Address" class="input-field" required>
                    <input type="password" id="signup-password" placeholder="Password (min. 6 characters)" class="input-field" required>
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-1">I am a:</label>
                        <select id="user-role" class="input-field">
                            <option value="seller">Seller (I want to sell recyclables)</option>
                            <option value="buyer">Buyer (I want to buy recyclables)</option>
                        </select>
                    </div>
                    <button type="submit" class="btn btn-primary w-full">Sign Up</button>
                </form>
                <p class="text-center mt-4">Already have an account? <a href="javascript:void(0);" onclick="navigateTo('login')" class="text-blue-600 hover:underline">Login here</a></p>
                <div id="signup-error" class="text-red-500 mt-2 text-center"></div>
            </div>
        </section>

        <section id="page-login" class="page-section">
            <div class="auth-container">
                <h2 class="text-2xl font-bold mb-6 text-center">Login to Go Can</h2>
                <form id="login-form">
                    <input type="email" id="login-email" placeholder="Email Address" class="input-field" required>
                    <input type="password" id="login-password" placeholder="Password" class="input-field" required>
                    <button type="submit" class="btn btn-primary w-full">Login</button>
                </form>
                <p class="text-center mt-4">Don't have an account? <a href="javascript:void(0);" onclick="navigateTo('signup')" class="text-blue-600 hover:underline">Sign up here</a></p>
                <div id="login-error" class="text-red-500 mt-2 text-center"></div>
            </div>
        </section>

        <section id="page-seller-dashboard" class="page-section">
            <div class="bg-white p-6 rounded-lg shadow-md">
                <h2 class="text-3xl font-bold mb-6">Seller Dashboard</h2>
                <div class="mb-8 p-4 border border-gray-200 rounded-lg">
                    <h3 class="text-xl font-semibold mb-3">Post New Listing</h3>
                    <form id="post-listing-form">
                        <div class="mb-3">
                            <label for="material-type" class="block text-sm font-medium text-gray-700">Material Type:</label>
                            <select id="material-type" class="input-field">
                                <option value="Kardus">Kardus (Cardboard)</option>
                                <option value="Botol Plastik PET">Botol Plastik PET (Plastic Bottles PET)</option>
                                <option value="Kertas Bekas">Kertas Bekas (Used Paper)</option>
                                <option value="Kaleng Aluminium">Kaleng Aluminium (Aluminum Cans)</option>
                                <option value="Besi Tua">Besi Tua (Scrap Metal)</option>
                                <option value="Lainnya">Lainnya (Other)</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="estimated-weight" class="block text-sm font-medium text-gray-700">Estimated Weight (kg, optional):</label>
                            <input type="number" id="estimated-weight" placeholder="e.g., 5" class="input-field">
                        </div>
                        <div class="mb-3">
                            <label class="block text-sm font-medium text-gray-700">Listing Location:</label>
                            <p class="text-xs text-gray-500 mb-1">Click on the map to set your listing's location.</p>
                            <div id="seller-map-picker" class="map-container"></div>
                            <input type="hidden" id="listing-lat">
                            <input type="hidden" id="listing-lng">
                            <p id="selected-location-text" class="text-sm text-gray-600 mt-1">No location selected.</p>
                        </div>
                        <button type="submit" class="btn btn-primary">Post Listing</button>
                    </form>
                    <div id="post-listing-message" class="mt-3"></div>
                </div>
                <div>
                    <h3 class="text-xl font-semibold mb-3">My Listings</h3>
                    <div id="my-listings-container" class="space-y-4">
                        <p>Loading your listings...</p>
                    </div>
                </div>
            </div>
        </section>

        <section id="page-buyer-dashboard" class="page-section">
            <div class="bg-white p-6 rounded-lg shadow-md">
                <h2 class="text-3xl font-bold mb-6">Buyer Dashboard</h2>
                <div class="mb-8 p-4 border border-gray-200 rounded-lg">
                    <h3 class="text-xl font-semibold mb-3">Browse Listings Near You</h3>
                    <p class="text-xs text-gray-500 mb-1">Listings are shown on the map. Click a marker for details.</p>
                    <div id="buyer-map-listings" class="map-container buyer-map-container"></div>
                    <div id="map-loading-status" class="text-center p-4">Loading map and listings...</div>
                </div>
                <div>
                    <h3 class="text-xl font-semibold mb-3">Listings You've Expressed Interest In</h3>
                    <div id="buyer-interactions-container" class="space-y-4">
                        <p>Loading your interactions...</p>
                    </div>
                </div>
            </div>
        </section>

        <div id="listing-detail-modal" class="modal">
            <div class="modal-content">
                <h4 id="modal-material-type" class="text-xl font-semibold mb-2"></h4>
                <p id="modal-estimated-weight" class="mb-1"></p>
                <p id="modal-seller-contact" class="mb-1"></p>
                <p id="modal-listing-status" class="mb-3"></p>
                <p id="modal-location-info" class="text-sm text-gray-500 mb-3"></p>
                <button id="express-interest-button" class="btn btn-primary mr-2">Express Interest</button>
                <button id="close-modal-button" class="btn btn-secondary">Close</button>
                <div id="interest-message" class="mt-2 text-sm"></div>
            </div>
        </div>

    </main>

    <footer class="text-center p-4 mt-8 text-gray-600">
        <p>© 2025 Go Can Hackathon. Built with Flask & Firebase.</p>
    </footer>

    <script>
        function initMapsGlobally() {
            // This function is called by the Google Maps script once it's loaded.
            // It dispatches an event that the main module script will listen for.
            console.log("Global initMapsGlobally called, dispatching 'google-maps-api-loaded-event'.");
            document.dispatchEvent(new CustomEvent('google-maps-api-loaded-event'));
        }
    </script>

    <script async defer src="https://maps.googleapis.com/maps/api/js?key={{ google_maps_api_key }}&libraries=places&callback=initMapsGlobally"></script>
    
    <script type="module">
        // --- START OF COMBINED JAVASCRIPT ---

        // --- firebase-config.js ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-auth.js";
        import { getFirestore, GeoPoint, doc, setDoc, getDoc, collection, addDoc, query, where, serverTimestamp, onSnapshot, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js";

        const firebaseConfig = {
          apiKey: "AIzaSyAjZmHaTXCHHGbmS-bg_H4KYrsm-53XtcA",
          authDomain: "gocanhackathon.firebaseapp.com",
          projectId: "gocanhackathon",
          storageBucket: "gocanhackathon.appspot.com",
          messagingSenderId: "975708950297",
          appId: "1:975708950297:web:9f87cce1ca6fc0ab2d3f88",
          measurementId: "G-XPDE8RZGT1"
        };

        const fbApp = initializeApp(firebaseConfig);
        const fbAuth = getAuth(fbApp);
        const fbDb = getFirestore(fbApp);

        // --- Global Navigation and Page State ---
        let currentPage = 'home'; // Default page
        let currentUser = null; // To store Firebase auth user object
        let sellerMapPickerInstance, buyerMapInstance; // To hold map instances
        let sellerMarker, buyerMarkers = [];
        let geocoderInstance;
        let googleMapsApiLoaded = false; // Flag to track if Google Maps API has loaded

        const pageSections = {
            home: document.getElementById('page-home'),
            signup: document.getElementById('page-signup'),
            login: document.getElementById('page-login'),
            seller_dashboard: document.getElementById('page-seller-dashboard'),
            buyer_dashboard: document.getElementById('page-buyer-dashboard'),
        };
        
        const navLinks = {
            home: document.getElementById('nav-home'),
            login: document.getElementById('nav-login'),
            signup: document.getElementById('nav-signup'),
            seller_dashboard: document.getElementById('nav-seller-dashboard'),
            buyer_dashboard: document.getElementById('nav-buyer-dashboard'),
        };

        window.navigateTo = (pageId) => {
            if (!pageSections[pageId]) {
                console.error("Page not found:", pageId);
                return;
            }
            
            Object.values(pageSections).forEach(section => section.classList.remove('active'));
            Object.values(navLinks).forEach(link => link.classList.remove('active'));

            pageSections[pageId].classList.add('active');
            if (navLinks[pageId]) navLinks[pageId].classList.add('active');
            
            currentPage = pageId;
            console.log("Navigated to:", currentPage);

            if (googleMapsApiLoaded) {
                if (currentPage === 'seller_dashboard' && !sellerMapPickerInstance) {
                    initSellerMapPicker();
                }
                if (currentPage === 'buyer_dashboard' && !buyerMapInstance) {
                    initBuyerMap();
                }
            }
            if (currentUser) {
                if (currentPage === 'seller_dashboard') loadSellerListings(currentUser);
                if (currentPage === 'buyer_dashboard') {
                    loadBuyerInteractions(currentUser);
                    if (buyerMapInstance) loadOpenListingsForBuyerMap();
                }
            }
        };
        
        // Listen for the custom event dispatched by the global initMapsGlobally
        document.addEventListener('google-maps-api-loaded-event', () => {
            console.log("Google Maps API loaded event received in module.");
            googleMapsApiLoaded = true; // Set the flag
            // Ensure google.maps and Geocoder are available before instantiation
            if (typeof google !== 'undefined' && typeof google.maps !== 'undefined' && typeof google.maps.Geocoder === 'function') {
                geocoderInstance = new google.maps.Geocoder();
            } else {
                console.error("Google Maps Geocoder could not be initialized after API load event. `google` object or `google.maps.Geocoder` is not available.");
                // Optionally, inform the user or try a fallback if maps are critical
                return; // Prevent further map-dependent operations if Geocoder fails
            }
            
            // Trigger map initialization if the current page needs it
            if (currentPage === 'seller_dashboard' && !sellerMapPickerInstance) {
                 initSellerMapPicker();
            }
            if (currentPage === 'buyer_dashboard' && !buyerMapInstance) {
                 initBuyerMap();
            }
        });


        // --- auth.js Logic ---
        const userInfoEl = document.getElementById('user-info');
        const logoutButtonEl = document.getElementById('logout-button');

        onAuthStateChanged(fbAuth, async (user) => {
            currentUser = user; 
            if (user) {
                console.log("User logged in:", user.uid, user.email);
                userInfoEl.textContent = `Logged in as: ${user.email}`;
                navLinks.login.classList.add('hidden');
                navLinks.signup.classList.add('hidden');
                logoutButtonEl.classList.remove('hidden');

                const userDocRef = doc(fbDb, "users", user.uid);
                try {
                    const userDocSnap = await getDoc(userDocRef);
                    if (userDocSnap.exists()) {
                        const userData = userDocSnap.data();
                        if (userData.role === 'seller') {
                            navLinks.seller_dashboard.classList.remove('hidden');
                            navLinks.buyer_dashboard.classList.add('hidden');
                            if (['login', 'signup', 'home'].includes(currentPage)) {
                                navigateTo('seller_dashboard');
                            }
                        } else if (userData.role === 'buyer') {
                            navLinks.buyer_dashboard.classList.remove('hidden');
                            navLinks.seller_dashboard.classList.add('hidden');
                            if (['login', 'signup', 'home'].includes(currentPage)) {
                                navigateTo('buyer_dashboard');
                            }
                        }
                        if (currentPage === 'seller_dashboard') loadSellerListings(user);
                        if (currentPage === 'buyer_dashboard') {
                             loadBuyerInteractions(user);
                             if (buyerMapInstance) loadOpenListingsForBuyerMap();
                        }

                    } else {
                        console.error("User document not found for UID:", user.uid, "Logging out.");
                        userInfoEl.textContent = `Logged in as: ${user.email} (Error: Role data missing. Please sign up again or contact support.)`;
                        await signOut(fbAuth); 
                    }
                } catch (error) {
                    console.error("Error fetching user role for UID:", user.uid, error);
                    userInfoEl.textContent = `Logged in as: ${user.email} (Error fetching role data)`;
                }
            } else {
                console.log("User logged out");
                currentUser = null;
                userInfoEl.textContent = '';
                navLinks.login.classList.remove('hidden');
                navLinks.signup.classList.remove('hidden');
                navLinks.seller_dashboard.classList.add('hidden');
                navLinks.buyer_dashboard.classList.add('hidden');
                logoutButtonEl.classList.add('hidden');
                
                const protectedPages = ['seller_dashboard', 'buyer_dashboard'];
                if (protectedPages.includes(currentPage)) {
                    navigateTo('login');
                }
            }
        });

        if (logoutButtonEl) {
            logoutButtonEl.addEventListener('click', async () => {
                try {
                    await signOut(fbAuth);
                    console.log('User signed out');
                    navigateTo('home'); 
                } catch (error) {
                    console.error('Sign out error', error);
                }
            });
        }

        async function handleUserSignup(email, password, role) {
            try {
                const userCredential = await createUserWithEmailAndPassword(fbAuth, email, password);
                const user = userCredential.user;
                await setDoc(doc(fbDb, "users", user.uid), {
                    email: user.email,
                    role: role,
                    createdAt: serverTimestamp() 
                });
                console.log("User signed up and role stored:", user.uid, role);
                return { success: true, user };
            } catch (error) {
                console.error("Signup error:", error);
                return { success: false, error };
            }
        }

        async function handleUserLogin(email, password) {
            try {
                const userCredential = await signInWithEmailAndPassword(fbAuth, email, password);
                console.log("User logged in:", userCredential.user.uid);
                return { success: true, user: userCredential.user };
            } catch (error) {
                console.error("Login error:", error);
                return { success: false, error };
            }
        }

        // --- auth_form.js Logic ---
        const signupFormEl = document.getElementById('signup-form');
        if (signupFormEl) {
            signupFormEl.addEventListener('submit', async (e) => {
                e.preventDefault();
                const email = document.getElementById('signup-email').value;
                const password = document.getElementById('signup-password').value;
                const role = document.getElementById('user-role').value;
                const signupErrorDiv = document.getElementById('signup-error');
                signupErrorDiv.textContent = '';
                if (password.length < 6) {
                    signupErrorDiv.textContent = 'Password should be at least 6 characters.';
                    return;
                }
                const result = await handleUserSignup(email, password, role);
                if (!result.success) {
                    signupErrorDiv.textContent = result.error.message || 'Signup failed.';
                } else {
                    console.log('Signup successful, onAuthStateChanged will handle navigation.');
                }
            });
        }

        const loginFormEl = document.getElementById('login-form');
        if (loginFormEl) {
            loginFormEl.addEventListener('submit', async (e) => {
                e.preventDefault();
                const email = document.getElementById('login-email').value;
                const password = document.getElementById('login-password').value;
                const loginErrorDiv = document.getElementById('login-error');
                loginErrorDiv.textContent = '';
                const result = await handleUserLogin(email, password);
                if (!result.success) {
                    loginErrorDiv.textContent = result.error.message || 'Login failed.';
                } else {
                     console.log('Login successful, onAuthStateChanged will handle navigation.');
                }
            });
        }

        // --- seller.js Logic ---
        const postListingFormEl = document.getElementById('post-listing-form');
        const materialTypeInputEl = document.getElementById('material-type');
        const estimatedWeightInputEl = document.getElementById('estimated-weight');
        const listingLatInputEl = document.getElementById('listing-lat');
        const listingLngInputEl = document.getElementById('listing-lng');
        const selectedLocationTextEl = document.getElementById('selected-location-text');
        const postListingMessageEl = document.getElementById('post-listing-message');
        const myListingsContainerEl = document.getElementById('my-listings-container');

        function initSellerMapPicker() {
            const mapDiv = document.getElementById('seller-map-picker');
            if (!mapDiv || !googleMapsApiLoaded || !geocoderInstance) { // Check geocoderInstance too
                console.warn("Seller map picker: div not found, Maps API not ready, or Geocoder not ready.");
                if (selectedLocationTextEl) selectedLocationTextEl.textContent = "Map loading...";
                return;
            }
            if (sellerMapPickerInstance) return; 

            console.log("Initializing Seller Map Picker");
            const defaultCenter = { lat: -2.548926, lng: 118.0148634 };
            sellerMapPickerInstance = new google.maps.Map(mapDiv, { center: defaultCenter, zoom: 5 });

            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        const userLoc = { lat: position.coords.latitude, lng: position.coords.longitude };
                        sellerMapPickerInstance.setCenter(userLoc);
                        sellerMapPickerInstance.setZoom(12);
                    },
                    () => console.warn("Seller Geolocation failed. Using default map center.")
                );
            }

            sellerMapPickerInstance.addListener('click', (mapsMouseEvent) => {
                const latLng = mapsMouseEvent.latLng;
                listingLatInputEl.value = latLng.lat();
                listingLngInputEl.value = latLng.lng();
                if (sellerMarker) sellerMarker.setMap(null);
                sellerMarker = new google.maps.Marker({ position: latLng, map: sellerMapPickerInstance });
                selectedLocationTextEl.textContent = `Selected: Lat: ${latLng.lat().toFixed(4)}, Lng: ${latLng.lng().toFixed(4)}`;
                if (geocoderInstance) { // Check if geocoderInstance is available
                    geocoderInstance.geocode({ location: latLng }, (results, status) => {
                        if (status === "OK" && results[0]) {
                            selectedLocationTextEl.textContent += ` (${results[0].formatted_address})`;
                        }
                    });
                } else {
                    console.warn("Geocoder instance not available for reverse geocoding in seller map.");
                }
            });
        }

        if (postListingFormEl) {
            postListingFormEl.addEventListener('submit', async (e) => {
                e.preventDefault();
                if (!currentUser) {
                    postListingMessageEl.textContent = "Must be logged in.";
                    postListingMessageEl.className = "text-red-500";
                    return;
                }
                const lat = parseFloat(listingLatInputEl.value);
                const lng = parseFloat(listingLngInputEl.value);
                if (!materialTypeInputEl.value || isNaN(lat) || isNaN(lng)) {
                    postListingMessageEl.textContent = "Material & location required.";
                    postListingMessageEl.className = "text-red-500";
                    return;
                }
                try {
                    await addDoc(collection(fbDb, "listings"), {
                        sellerId: currentUser.uid,
                        sellerEmail: currentUser.email,
                        material: materialTypeInputEl.value,
                        estimatedWeight: estimatedWeightInputEl.value || "N/A",
                        location: new GeoPoint(lat, lng),
                        status: "Open",
                        createdAt: serverTimestamp()
                    });
                    postListingMessageEl.textContent = "Listing posted!";
                    postListingMessageEl.className = "text-green-500";
                    postListingFormEl.reset();
                    selectedLocationTextEl.textContent = "No location selected.";
                    if (sellerMarker) sellerMarker.setMap(null);
                } catch (error) {
                    console.error("Error posting listing: ", error);
                    postListingMessageEl.textContent = "Error: " + error.message;
                    postListingMessageEl.className = "text-red-500";
                }
            });
        }
        
        function renderSellerListingCard(listingData, listingId) {
            const card = document.createElement('div');
            card.className = 'listing-card shadow-sm';
            card.innerHTML = `
                <h4 class="text-lg font-semibold">${listingData.material}</h4>
                <p class="text-sm text-gray-600">Weight: ${listingData.estimatedWeight} kg</p>
                <p class="text-sm text-gray-600">Status: <span class="font-medium ${listingData.status === 'Open' ? 'text-green-600' : listingData.status === 'OfferPending' ? 'text-yellow-600' : 'text-blue-600'}">${listingData.status}</span></p>
                <p class="text-xs text-gray-500">Posted: ${listingData.createdAt ? new Date(listingData.createdAt.seconds * 1000).toLocaleDateString() : 'N/A'}</p>
                ${listingData.status === 'OfferPending' && listingData.offerByBuyerEmail ? `<p class="text-sm text-blue-600">Offer from: ${listingData.offerByBuyerEmail}</p>` : ''}
                <div class="mt-2 space-x-2">
                    ${listingData.status === 'OfferPending' ? `<button data-id="${listingId}" class="accept-offer-btn btn btn-primary btn-sm">Accept Offer</button>` : ''}
                    <button data-id="${listingId}" class="delete-listing-btn btn btn-secondary btn-sm bg-red-500 hover:bg-red-700">Delete</button>
                </div>`;
            
            card.querySelector('.delete-listing-btn')?.addEventListener('click', async () => {
                if (confirm('Delete this listing?')) {
                    try { await deleteDoc(doc(fbDb, "listings", listingId)); } 
                    catch (e) { console.error("Delete error", e); alert("Error deleting.");}
                }
            });
            card.querySelector('.accept-offer-btn')?.addEventListener('click', async () => {
                if (confirm('Accept this offer?')) {
                    try { await updateDoc(doc(fbDb, "listings", listingId), { status: "Accepted" }); }
                    catch (e) { console.error("Accept error", e); alert("Error accepting.");}
                }
            });
            return card;
        }

        let sellerListingsUnsubscribe = null;
        function loadSellerListings(user) {
            if (!user || !myListingsContainerEl) return;
            if (sellerListingsUnsubscribe) sellerListingsUnsubscribe(); 

            const q = query(collection(fbDb, "listings"), where("sellerId", "==", user.uid));
            sellerListingsUnsubscribe = onSnapshot(q, (querySnapshot) => {
                myListingsContainerEl.innerHTML = '';
                if (querySnapshot.empty) {
                    myListingsContainerEl.innerHTML = '<p>You have no listings.</p>'; return;
                }
                querySnapshot.forEach((docSnap) => {
                    myListingsContainerEl.appendChild(renderSellerListingCard(docSnap.data(), docSnap.id));
                });
            }, (error) => {
                console.error("Error fetching seller listings: ", error);
                myListingsContainerEl.innerHTML = '<p>Error loading listings.</p>';
            });
        }


        // --- buyer.js Logic ---
        const buyerMapListingsDivEl = document.getElementById('buyer-map-listings');
        const mapLoadingStatusEl = document.getElementById('map-loading-status');
        const buyerInteractionsContainerEl = document.getElementById('buyer-interactions-container');
        const listingDetailModalEl = document.getElementById('listing-detail-modal');
        const modalMaterialTypeEl = document.getElementById('modal-material-type');
        const modalEstimatedWeightEl = document.getElementById('modal-estimated-weight');
        const modalSellerContactEl = document.getElementById('modal-seller-contact');
        const modalListingStatusEl = document.getElementById('modal-listing-status');
        const modalLocationInfoEl = document.getElementById('modal-location-info');
        const expressInterestButtonEl = document.getElementById('express-interest-button');
        const closeModalButtonEl = document.getElementById('close-modal-button');
        const interestMessageEl = document.getElementById('interest-message');
        let currentListingIdForBuyer = null;

        function initBuyerMap() {
            if (!buyerMapListingsDivEl || !googleMapsApiLoaded) { 
                 console.warn("Buyer map: div not found or Maps API not ready.");
                 if(mapLoadingStatusEl) mapLoadingStatusEl.textContent = "Map loading...";
                return;
            }
            if (buyerMapInstance) return; 

            console.log("Initializing Buyer Map");
            const defaultCenter = { lat: -2.548926, lng: 118.0148634 };
            buyerMapInstance = new google.maps.Map(buyerMapListingsDivEl, { center: defaultCenter, zoom: 5 });
            
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        const userLoc = { lat: position.coords.latitude, lng: position.coords.longitude };
                        buyerMapInstance.setCenter(userLoc);
                        buyerMapInstance.setZoom(10);
                        new google.maps.Marker({ position: userLoc, map: buyerMapInstance, title: "Your Location", icon: { url: "http://maps.google.com/mapfiles/ms/icons/blue-dot.png" }}); // Changed icon for visibility
                    },
                    () => console.warn("Buyer Geolocation failed. Using default map center.")
                );
            }
            loadOpenListingsForBuyerMap();
        }

        function clearBuyerMarkers() {
            buyerMarkers.forEach(marker => marker.setMap(null));
            buyerMarkers = [];
        }

        let openListingsUnsubscribe = null;
        function loadOpenListingsForBuyerMap() {
            if (!buyerMapInstance) {
                console.warn("loadOpenListingsForBuyerMap called but buyerMapInstance is not ready.");
                return;
            }
            if (openListingsUnsubscribe) openListingsUnsubscribe();

            if(mapLoadingStatusEl) mapLoadingStatusEl.textContent = "Fetching listings...";
            const q = query(collection(fbDb, "listings"), where("status", "==", "Open"));
            openListingsUnsubscribe = onSnapshot(q, (querySnapshot) => {
                clearBuyerMarkers();
                if (querySnapshot.empty) {
                    if(mapLoadingStatusEl) mapLoadingStatusEl.textContent = "No open listings currently available.";
                    return;
                }
                if(mapLoadingStatusEl) mapLoadingStatusEl.style.display = 'none';

                querySnapshot.forEach((docSnap) => {
                    const listing = docSnap.data();
                    const listingId = docSnap.id;
                    if (listing.location?.latitude && listing.location?.longitude) {
                        const marker = new google.maps.Marker({
                            position: { lat: listing.location.latitude, lng: listing.location.longitude },
                            map: buyerMapInstance,
                            title: `${listing.material} (Status: ${listing.status})`,
                        });
                        marker.addListener('click', () => {
                            currentListingIdForBuyer = listingId;
                            modalMaterialTypeEl.textContent = `Material: ${listing.material}`;
                            modalEstimatedWeightEl.textContent = `Est. Weight: ${listing.estimatedWeight || 'N/A'} kg`;
                            modalSellerContactEl.textContent = `Seller: ${listing.sellerEmail}`;
                            modalListingStatusEl.textContent = `Status: ${listing.status}`;
                            modalLocationInfoEl.textContent = `Lat: ${listing.location.latitude.toFixed(4)}, Lng: ${listing.location.longitude.toFixed(4)}`;
                            interestMessageEl.textContent = '';
                            expressInterestButtonEl.disabled = listing.status !== "Open";
                            expressInterestButtonEl.textContent = listing.status === "Open" ? "Express Interest" : "Unavailable";
                            listingDetailModalEl.style.display = 'flex';
                        });
                        buyerMarkers.push(marker);
                    }
                });
            }, (error) => {
                console.error("Error fetching open listings for map: ", error);
                if(mapLoadingStatusEl) mapLoadingStatusEl.textContent = "Error loading listings.";
            });
        }
        
        closeModalButtonEl?.addEventListener('click', () => listingDetailModalEl.style.display = 'none');
        expressInterestButtonEl?.addEventListener('click', async () => {
            if (!currentUser || !currentListingIdForBuyer) {
                interestMessageEl.textContent = "Login required / No listing selected.";
                interestMessageEl.className = "text-red-500"; return;
            }
            try {
                await updateDoc(doc(fbDb, "listings", currentListingIdForBuyer), {
                    status: "OfferPending",
                    offerByBuyerId: currentUser.uid,
                    offerByBuyerEmail: currentUser.email
                });
                interestMessageEl.textContent = "Interest expressed!";
                interestMessageEl.className = "text-green-500";
                expressInterestButtonEl.disabled = true;
            } catch (error) {
                console.error("Error expressing interest: ", error);
                interestMessageEl.textContent = "Error: " + error.message;
                interestMessageEl.className = "text-red-500";
            }
        });

        function renderBuyerInteractionCard(listingData) {
            const card = document.createElement('div');
            card.className = 'listing-card shadow-sm';
            card.innerHTML = `
                <h4 class="text-lg font-semibold">${listingData.material}</h4>
                <p class="text-sm text-gray-600">Seller: ${listingData.sellerEmail}</p>
                <p class="text-sm text-gray-600">Status: <span class="font-medium ${listingData.status === 'Open' ? 'text-green-600' : listingData.status === 'OfferPending' ? 'text-yellow-600' : listingData.status === 'Accepted' ? 'text-blue-600' : 'text-gray-500'}">${listingData.status}</span></p>
                <p class="text-xs text-gray-500">Originally Posted: ${listingData.createdAt ? new Date(listingData.createdAt.seconds * 1000).toLocaleDateString() : 'N/A'}</p>
                ${listingData.status === 'Accepted' ? '<p class="text-sm text-green-600 font-semibold">This deal was accepted by the seller!</p>' : ''}`;
            return card;
        }

        let buyerInteractionsUnsubscribe = null;
        function loadBuyerInteractions(user) {
            if (!user || !buyerInteractionsContainerEl) return;
            if (buyerInteractionsUnsubscribe) buyerInteractionsUnsubscribe();

            buyerInteractionsContainerEl.innerHTML = '<p>Loading interactions...</p>';
            const q = query(collection(fbDb, "listings"), where("offerByBuyerId", "==", user.uid));
            buyerInteractionsUnsubscribe = onSnapshot(q, (querySnapshot) => {
                buyerInteractionsContainerEl.innerHTML = '';
                if (querySnapshot.empty) {
                    buyerInteractionsContainerEl.innerHTML = '<p>No interactions yet.</p>'; return;
                }
                querySnapshot.forEach((docSnap) => {
                    buyerInteractionsContainerEl.appendChild(renderBuyerInteractionCard(docSnap.data()));
                });
            }, (error) => {
                console.error("Error fetching buyer interactions: ", error);
                buyerInteractionsContainerEl.innerHTML = '<p>Error loading interactions.</p>';
            });
        }

        // --- Initial Page Load ---
        const initialHash = window.location.hash.substring(1);
        navigateTo(pageSections[initialHash] ? initialHash : 'home');
        
        // Simplified navigation handling without relying on hash changes for this version
        // to avoid complexities with auth redirects and initial load.

        // --- END OF COMBINED JAVASCRIPT ---
    </script>
</body>
</html>
